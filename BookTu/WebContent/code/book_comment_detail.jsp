<%@ page contentType="text/html; charset=utf-8" language="java" import="java.sql.*" errorPage="" %>
<%@page import="java.text.SimpleDateFormat"%>
<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> 
       
<html class="no-js"> <!--<![endif]-->
    <head>

        <title>BookTu</title>

        <!-- meta -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

        
        <!-- stylesheets -->
        <link rel="stylesheet" href="assets/css/bootstrap.min.css">
        <link rel="stylesheet" href="assets/css/font-awesome.min.css">
        <link rel="stylesheet" href="assets/css/animate.css">
        <link rel="stylesheet" href="assets/css/owl.carousel.css">
        <link rel="stylesheet" href="assets/css/owl.theme.css">
        <link rel="stylesheet" href="assets/css/style.css">

    </head>

    <body>
    
    	<%@ include file="dbconnect.jsp"%>  
	    <% request.setCharacterEncoding("UTF-8"); %>
	    <jsp:include page="head.jsp" flush="true"/>
	    
	    <% String book_comment_id=request.getParameter("book_comment_id"); 	
	    %>
	    
	    
        <div id="single-blog-page">
            <!-- header begin -->
            <header class="page-head">
                <div class="header-wrapper">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-12">

                                <ol class="breadcrumb">
                                    <li><a href="#">书评</a></li>
                                    <li class="active">详情</li>
                                </ol> <!-- end of /.breadcrumb -->

                            </div>
                        </div>
                    </div> <!-- /.container -->
                </div> <!-- /.header-wrapper -->
            </header> <!-- /.page-head (header end) -->
            
            <%
		        Statement stmt1 = connect.createStatement();
		        ResultSet rs1=stmt1.executeQuery("select * from BookComment where book_comment_id = " + book_comment_id  +  ";");
		      	rs1.next();
	      		Statement stmt2 = connect.createStatement();
	        	ResultSet rs2=stmt2.executeQuery("select * from User where user_id = " + rs1.getInt(2)  +  ";");
	      		rs2.next();  
	      		Statement stmt3 = connect.createStatement();
	      		ResultSet rs3=stmt3.executeQuery("select * from Book where book_id = " + rs1.getInt(3)  +  ";");
	      		rs3.next();  
	      		
	      		Statement stmt6 = connect.createStatement();
	        	ResultSet rs6=stmt6.executeQuery("select count(*) from BookCommentReply where book_comment_id = " + book_comment_id  +  ";");
	      		rs6.next();
	      		int comment_num = rs6.getInt(1);
		    %>


            <section class="blog-content">
                <div class="container">
                    <div class="row">
                        <main class="col-md-9" style="display: block;">
                            <article class="blog-item">
                                <img class="img-responsive center-block" src="assets/img/blog.png">
                                <div class="blog-heading">
                                    <h3 class="text-capitalize"><%=rs1.getString(5)%></h3>
                                    <span><%=rs2.getString(3) %> 评论  <%=rs3.getString(3) %> </span>
                               		<h5></h5>
                                    <span class="date"><%=rs1.getString(4) %></span>
                                    <span><%=comment_num %> comments</span>
                                </div>
                                <p>
                                    <%=rs1.getString(6) %>
                                </p>


                                <div class="comments">
                                    <div class="row">
                                        <div class="col-md-12">
                                        <h3><%=comment_num %> Comments</h3>
                                        <% 
                                        	Statement stmt4 = connect.createStatement();
								        	ResultSet rs4=stmt4.executeQuery("select * from BookCommentReply where book_comment_id = " + book_comment_id  +  ";");
								      		
								        	
								        	while (rs4.next() ) {  
								      		Statement stmt5 = connect.createStatement();
								      		ResultSet rs5=stmt5.executeQuery("select * from User where user_id = " + rs4.getInt(2)  +  ";");
								      		rs5.next();  
                                        %>
                                        
              
                                            <div class="cmnt-clipboard"><span class="btn-clipboard">Reply</span></div>
                                            <div class="well">
                                                <div class="row">
                                                    <div class="col-md-2">
                                                        <img src="assets/img/avatar.jpg" class="img-responsive center-block">
                                                    </div>
                                                    <div class="col-md-10">
                                                        <p class="comment-info">
                                                            <strong><%=rs5.getString(3) %></strong> <span><%=rs4.getString(4) %></span>
                                                        </p>
                                                        <p>
                                                       		<%=rs4.getString(5) %>     
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
											
										<%}
								        	%>
                     
                                        </div>
                                    </div>
                                </div>

                                <div class="comment-post">
                                    <h3>Post A Comment</h3>
                                    <form method="post" action="" >
                                        <div class="row">
                                            <div class="col-md-12">
                                                <textarea name="message" type="text" class="form-control" id="message" rows="8" required="required" placeholder="写下你对该书评的感想"></textarea>
                                            </div>
                                        </div>
                                        
                                        <button type="submit" id="submit" name="submit" class="btn btn-black">post comment</button>
                                    </form>
                                    
                                      
                                <% 
	
								String content = request.getParameter("message");  						 
								if(content!=null && content != "")
								{		
									
									try{
										
										    String user_id = session.getAttribute("login_id").toString();
										    java.util.Date d = new java.util.Date();
											SimpleDateFormat df = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
											String now = df.format(d);
																				
											Statement stm=connect.createStatement();
											String sqlq="select * from BookCommentReply order by book_comment_reply_id desc limit 1;";
											ResultSet rs=stm.executeQuery(sqlq);
											int book_comment_reply_id=1;
											if(rs.next())
											{
												book_comment_reply_id=rs.getInt(1)+1;
											}
							
											
											String sql="insert into BookCommentReply(book_comment_reply_id,user_id,book_comment_id,time,content) values(?,?,?,?,?)";
											PreparedStatement pstmt=connect.prepareStatement(sql);
											pstmt.setInt(1, book_comment_reply_id);
										    pstmt.setInt(2, Integer.parseInt(user_id));
										    pstmt.setInt(3, Integer.parseInt(book_comment_id));
										    pstmt.setString(4, now);
										    pstmt.setString(5, content);
										    
										    pstmt.executeUpdate();
										
										
											%>
										    <script type="text/javascript">
										    	window.location.replace("book_review.jsp");
										    </script><%
										
										
									}
									catch(Exception e) {
										e.printStackTrace();
										System.out.println("yyyy");
									}
									
								}

							%>
                                    
                                    
                                    
                                </div>
                            </article>
                        </main>


                        <aside class="col-md-3">
						 	<jsp:include page="side_note.jsp" flush="true"/>
              				
                        </aside>
                        
                        
                    </div>
                </div>
            </section>


            


            <jsp:include page="PC_foot.jsp" flush="true"/>

        </div> 
        <!-- end of /#multiple-blog-page -->


        <script type="text/javascript" src="assets/js/jquery-2.1.3.min.js"></script>
        <script type="text/javascript" src="assets/js/bootstrap.min.js"></script>
        <!--     script for FAQ  -->

        <script>
            $(".faq-q").click( function () {
              var container = $(this).parents(".faq-c");
              var answer = container.find(".faq-a");
              var trigger = container.find(".faq-t");
              
              answer.slideToggle(200);
              
              if (trigger.hasClass("faq-o")) {
                trigger.removeClass("faq-o");
              }
              else {
                trigger.addClass("faq-o");
              }
            });
        </script>
    </body>
</html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  